<%- include("partials/dynamicHeader")-%>
<style>
  body {
    background-image: url(../images/course_bg.jpg);
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
  }

  /* existing styles */

  h1 {
    font-size: 36px;
    margin: 20px;
    font-size: 36px;
    /* margin: 20px; */
    color: #333; /* new style */
    text-align: center; /* new style */
    text-decoration: underline; /* new style */
  }

  /* existing styles */


  h2 {
    font-size: 30px;
    margin: 10px 0;
  }

  h4 {
    font-size: 18px;
    margin: 5px 0;
    margin-left: 2px;
  }

  p {
    margin: 10px 0;
  }

  form {
    display: inline-block;
    margin-left: 10px;
  }

  button {
    background-color: #007bff;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin: 5px;
  }

  button:hover {
    background-color: #0062cc;
  }
  .success{
    color: green;
  }
  .unSuccess{
    color: red;
  }
</style>
<% if (course.length > 0) { %>
  <% if (all.length > 0) { %>
    <% course.sort(function(a, b) {
      const classA = parseInt(a.classs.match(/\d+/)[0]);
      const classB = parseInt(b.classs.match(/\d+/)[0]);

      // Compare the numeric parts as numbers
      return classA - classB;
    });
    %>
    <h1><u>All The Courses Available:  %></u></h1>
  <% }else{ %>
  <h1><u>Available Courses for <%= course[0].classs  %></u></h1>
  <% } %>
  <p class="success"><%= msg %></p>
  <p class="unSuccess"><%= msgUn %></p>
    <h3>Tutors:</h3>
    <% course.forEach(function(tutor) { %>
      <div class="container">
        <div class="row">
          <div class="col-sm">
            <h4><%= tutor.courseName %></h4>
          </div>
          <div class="col-sm">
            <p><strong>Tutor :</strong> <%= tutor.teacher_name %></p>
          </div>
          <% if(all.length > 0){ %>
          <div class="col-sm">
            <p><strong><%= tutor.classs.slice(0, 5) %>: <%= tutor.classs.slice(5) %></strong></p>

          </div>
          <% } %>
          <div class="col-sm">
            <p><strong>Price :</strong> Rs.<%= tutor.fees %></p>
          </div>
          <div class="col-sm">
            <form onsubmit="event.preventDefault(); makePayment('<%= tutor._id %>', '<%= tutor.fees %>' , '<%= course[0].classs  %>');">
              <input type="hidden" name="courseId" value="<%= tutor._id %>">
              <input type="hidden" name="amount" value="<%= tutor.fees %>">
              <% if (user) { %>
                <button type="submit">Buy</button>
              <% } else { %>
                <button type="submit"  onclick="redirectToLogin()">Please log in to proceed</button>
              <% } %>
              
              <script>
                function redirectToLogin() {
                  window.location.href = '/login'; // Replace '/login' with the actual login page URL
                }
              </script>
              
              
              
            </form>
            
          </div>
        </div>
      </div>
    <% }); %>
  <% } else { %>
    <p>Finding teachers for this class</p>
  <% } %>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    function encrypt(data, secretKey) {
    const encrypted = CryptoJS.AES.encrypt(data, secretKey);
    return encrypted.toString();
  }
    function makePayment(courseId, amount, classs) {
      
      fetch('/payment', {
        method: 'POST',headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ courseId: courseId }) // Send the courseId to the server
    }).then((response) => response.json())
.then((order) => {
  const options = {
    key: 'rzp_test_gweFtrGgAHg1sk',
    amount: amount * 100, // Assuming the amount is in rupees
    currency: 'INR',
    name: 'Tutors Academy',
    description: 'nothing',
    image: 'https://yourcompany.com/logo.png', // URL of your logo
    order_id: order.id,
    // handling the success
    handler: function (response) {
      // console.log(process.env.RAZORPAY_KEY_ID);
    const paymentId = response.razorpay_payment_id;
    // const encryptionKey = 'my-secret-key'; // Replace with your actual secret key
    // const encryptedPaymentId = encrypt(paymentId, encryptionKey);
    // const encryptedCourseId = encrypt(courseId, encryptionKey);
    // const encryptedClasss = encrypt(classs, encryptionKey);
    const encryptedPaymentId = paymentId;
    const encryptedCourseId = courseId;
    const encryptedClasss = classs;

    const encryptedUrl = `/payment-success?epayment_id=${encryptedPaymentId}&ecourseId=${encryptedCourseId}&eclasss=${encryptedClasss}`;
    window.location.href = encryptedUrl;

},

  };

  const rzp1 = new Razorpay(options);
  rzp1.open();
})
.catch((error) => {
  console.error(error);
  alert('An error occurred');
});

    }
  </script>
  
  
  <div>
    <div style="margin-left: 10%;">
      
    </div>
    
    
    <hr>
  </div>

<%- include("partials/footer")-%>


